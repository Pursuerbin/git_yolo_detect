# 绝缘子缺陷检测系统 - 环境配置指导

本文档详细说明绝缘子缺陷检测系统在不同环境下的配置变更方法，帮助开发者和运维人员快速适应不同的部署环境。

## 1. 配置文件概述

### 1.1 配置文件结构

系统使用 `.env` 文件管理所有配置项，位于 `backend` 目录下：

```
backend/
├── .env            # 环境配置文件
└── .env.example    # 配置文件模板
```

### 1.2 配置文件使用方法

1. **首次部署**：复制 `.env.example` 文件为 `.env`
2. **环境变更**：修改 `.env` 文件中的对应配置项
3. **重启服务**：修改配置后需要重启后端服务使配置生效

## 2. 不同环境下的配置变更

### 2.1 Windows 环境

**基本配置**：
- 保持默认配置即可正常运行
- 数据库默认使用 `localhost`
- 端口默认使用 `5000`

**特殊配置**：
- Windows 环境下 GPU 配置可能需要额外的 CUDA 环境
- 路径分隔符使用 `\`，但配置文件中仍使用 `/`

### 2.2 Linux 环境

**基本配置**：
- 需要修改数据库连接配置
- 可能需要调整端口和 IP 配置

**特殊配置**：
- Linux 环境下需要确保文件权限正确
- GPU 配置通常更容易生效
- 路径分隔符使用 `/`

### 2.3 Docker 容器环境

**基本配置**：
- 需要使用容器内部的 IP 地址
- 数据库连接需要使用容器名称或网络别名

**特殊配置**：
- 端口映射需要在 Docker 命令中指定
-  volumes 需要正确挂载

## 3. 常见配置变更指南

### 3.1 IP 地址变更

**场景**：服务器更换或网络环境变更

**配置项**：
```env
# 服务器IP地址
SERVER_IP=0.0.0.0  # 0.0.0.0 表示监听所有网络接口
```

**变更方法**：
1. 修改 `SERVER_IP` 为新的服务器 IP 地址
2. 如果需要限制访问，可以设置为特定的网络接口 IP
3. 同时需要更新 `ALLOWED_ORIGINS` 中的前端地址

### 3.2 数据库配置变更

**场景**：数据库服务器更换、密码修改或数据库名称变更

**配置项**：
```env
# ===== 数据库配置 =====
DB_HOST=localhost      # 数据库主机地址
DB_USER=root           # 数据库用户名
DB_PASSWORD=123456     # 数据库密码
DB_NAME=insulator_detection  # 数据库名称
```

**变更方法**：
1. 修改 `DB_HOST` 为新的数据库服务器地址
2. 修改 `DB_USER` 为数据库用户名
3. 修改 `DB_PASSWORD` 为新的数据库密码
4. 修改 `DB_NAME` 为数据库名称
5. 确保新的数据库中已创建 `insulator_detection` 数据库

### 3.3 端口变更

**场景**：默认端口被占用或需要使用其他端口

**配置项**：
```env
# 服务器端口
SERVER_PORT=5000
```

**变更方法**：
1. 修改 `SERVER_PORT` 为新的端口号
2. 同时需要更新防火墙规则，允许新端口的访问
3. 更新前端配置中的 API 地址端口

### 3.4 设备配置变更

**场景**：需要强制使用 CPU 或 GPU

**配置项**：
```env
# GPU使用策略：auto, true, false
USE_GPU=auto
```

**变更方法**：
- `auto`：自动检测，优先使用 GPU
- `true`：强制使用 GPU（如果不可用会失败）
- `false`：强制使用 CPU

### 3.5 模型配置变更

**场景**：需要更换默认模型或调整检测参数

**配置项**：
```env
# 默认使用的模型文件
DEFAULT_MODEL=best.pt
# 置信度阈值
CONF_THRESHOLD=0.25
# IoU阈值
IOU_THRESHOLD=0.45
```

**变更方法**：
1. 修改 `DEFAULT_MODEL` 为新的模型文件名（需要放在 `models` 目录下）
2. 调整 `CONF_THRESHOLD` 改变检测灵敏度
3. 调整 `IOU_THRESHOLD` 改变重叠目标的处理方式

### 3.6 CORS 配置变更

**场景**：前端部署地址变更

**配置项**：
```env
# 允许的前端地址（多个地址用逗号分隔）
ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
```

**变更方法**：
- 添加新的前端地址到 `ALLOWED_ORIGINS`
- 多个地址使用逗号分隔
- 确保地址格式正确，包含协议和端口

## 4. 环境迁移步骤

### 4.1 从 Windows 迁移到 Linux

1. **准备 Linux 环境**：
   - 安装 Python 3.8+
   - 安装 MySQL 8.0+
   - 安装必要的系统依赖

2. **复制代码和配置**：
   - 复制整个项目目录到 Linux 服务器
   - 复制 `.env` 文件或根据模板创建

3. **修改配置文件**：
   - 更新数据库连接配置
   - 更新 IP 和端口配置
   - 调整文件路径配置（如果需要）

4. **安装依赖**：
   ```bash
   pip install flask flask-cors pymysql torch torchvision opencv-python ultralytics numpy psutil python-dotenv
   ```

5. **启动服务**：
   ```bash
   cd backend
   python app.py
   ```

### 4.2 从开发环境迁移到生产环境

1. **修改环境配置**：
   ```env
   # 运行环境：development, production
   FLASK_ENV=production
   ```

2. **优化数据库配置**：
   - 使用独立的数据库服务器
   - 配置合适的数据库连接池

3. **优化性能配置**：
   - 根据服务器硬件调整内存限制
   - 配置合适的 GPU 使用策略

4. **加强安全配置**：
   - 修改数据库密码为强密码
   - 限制 CORS 来源
   - 配置 HTTPS

## 5. 配置项详细说明

### 5.1 服务器配置

| 配置项 | 说明 | 默认值 | 变更建议 |
|-------|------|-------|----------|
| SERVER_IP | 服务器IP地址 | 0.0.0.0 | 0.0.0.0表示监听所有接口 |
| SERVER_PORT | 服务器端口 | 5000 | 根据实际情况调整 |
| FLASK_ENV | 运行环境 | development | 生产环境改为production |

### 5.2 数据库配置

| 配置项 | 说明 | 默认值 | 变更建议 |
|-------|------|-------|----------|
| DB_HOST | 数据库主机 | localhost | 远程数据库需改为对应IP |
| DB_USER | 数据库用户名 | root | 根据实际数据库用户 |
| DB_PASSWORD | 数据库密码 | 123456 | 生产环境必须修改 |
| DB_NAME | 数据库名称 | insulator_detection | 保持不变 |

### 5.3 模型配置

| 配置项 | 说明 | 默认值 | 变更建议 |
|-------|------|-------|----------|
| DEFAULT_MODEL | 默认模型 | best.pt | 根据模型文件调整 |
| CONF_THRESHOLD | 置信度阈值 | 0.25 | 0.1-0.5之间调整 |
| IOU_THRESHOLD | IoU阈值 | 0.45 | 0.3-0.6之间调整 |

### 5.4 性能配置

| 配置项 | 说明 | 默认值 | 变更建议 |
|-------|------|-------|----------|
| MAX_IMAGE_SIZE | 最大图片尺寸 | 1280 | 根据内存调整 |
| MAX_MEMORY_PERCENT | 最大内存使用 | 85.0 | 根据服务器内存调整 |
| USE_GPU | GPU使用策略 | auto | auto, true, false |

### 5.5 路径配置

| 配置项 | 说明 | 默认值 | 变更建议 |
|-------|------|-------|----------|
| UPLOAD_FOLDER | 上传目录 | uploads | 保持不变 |
| RESULT_FOLDER | 结果目录 | results | 保持不变 |
| VIDEO_FOLDER | 视频目录 | videos | 保持不变 |
| MODEL_FOLDER | 模型目录 | models | 保持不变 |
| STATIC_FOLDER | 静态目录 | static | 保持不变 |
| LOG_FOLDER | 日志目录 | logs | 保持不变 |

### 5.6 安全配置

| 配置项 | 说明 | 默认值 | 变更建议 |
|-------|------|-------|----------|
| ALLOWED_IMAGE_EXTENSIONS | 允许的图片格式 | png,jpg,jpeg | 保持不变 |
| ALLOWED_VIDEO_EXTENSIONS | 允许的视频格式 | mp4,avi,mov,mkv | 保持不变 |
| ALLOWED_ORIGINS | 允许的前端地址 | http://localhost:5173,http://127.0.0.1:5173 | 根据前端地址调整 |

## 6. 故障排查

### 6.1 配置相关问题

| 问题 | 可能原因 | 解决方案 |
|-----|---------|----------|
| 数据库连接失败 | 数据库配置错误 | 检查DB_HOST、DB_USER、DB_PASSWORD配置 |
| 模型加载失败 | 模型文件不存在 | 检查DEFAULT_MODEL配置和models目录 |
| CORS错误 | 前端地址未在ALLOWED_ORIGINS中 | 添加前端地址到ALLOWED_ORIGINS |
| 端口被占用 | 端口冲突 | 修改SERVER_PORT配置 |
| GPU不可用 | CUDA环境问题或配置错误 | 检查USE_GPU配置和CUDA环境 |

### 6.2 日志查看

配置问题可以通过查看日志文件定位：

```bash
# 查看后端日志
cd backend
cat app.log

# 或查看控制台输出
python app.py
```

### 6.3 常见错误解决

**数据库连接错误**：
- 确保MySQL服务正在运行
- 确保数据库用户权限正确
- 确保数据库存在

**模型加载错误**：
- 确保模型文件存在于models目录
- 确保模型文件格式正确
- 检查GPU驱动是否正常

**端口占用错误**：
- 使用 `netstat -ano` 查看端口占用
- 修改配置文件中的端口
- 关闭占用端口的进程

## 7. 最佳实践

### 7.1 配置管理

1. **版本控制**：不要将 `.env` 文件提交到版本控制，只提交 `.env.example`
2. **环境隔离**：为不同环境创建不同的 `.env` 文件
3. **配置备份**：定期备份配置文件

### 7.2 安全建议

1. **密码管理**：使用强密码并定期更换
2. **权限控制**：限制数据库用户权限
3. **网络安全**：使用防火墙限制访问
4. **HTTPS**：生产环境使用 HTTPS

### 7.3 性能优化

1. **硬件适配**：根据服务器硬件调整配置
2. **资源监控**：定期检查系统资源使用情况
3. **配置调优**：根据实际负载调整配置参数

## 8. 附录

### 8.1 配置文件模板

完整的 `.env.example` 文件内容：

```env
# 绝缘子缺陷检测系统 - 环境配置文件
# 复制此文件为.env并根据实际环境修改配置

# ===== 服务器配置 =====
# 服务器IP地址
SERVER_IP=0.0.0.0
# 服务器端口
SERVER_PORT=5000
# 运行环境：development, production
FLASK_ENV=development

# ===== 数据库配置 =====
# 数据库主机地址
DB_HOST=localhost
# 数据库用户名
DB_USER=root
# 数据库密码
DB_PASSWORD=123456
# 数据库名称
DB_NAME=insulator_detection

# ===== 模型配置 =====
# 默认使用的模型文件
DEFAULT_MODEL=best.pt
# 置信度阈值
CONF_THRESHOLD=0.25
# IoU阈值
IOU_THRESHOLD=0.45

# ===== 性能配置 =====
# 最大图片尺寸（像素）
MAX_IMAGE_SIZE=1280
# 最大内存使用百分比
MAX_MEMORY_PERCENT=85.0
# GPU使用策略：auto, true, false
USE_GPU=auto

# ===== 网络配置 =====
# 是否使用Tailscale VPN
USE_TAILSCALE=false

# ===== 路径配置 =====
# 上传文件目录
UPLOAD_FOLDER=uploads
# 结果文件目录
RESULT_FOLDER=results
# 视频文件目录
VIDEO_FOLDER=videos
# 模型文件目录
MODEL_FOLDER=models
# 静态文件目录
STATIC_FOLDER=static
# 日志文件目录
LOG_FOLDER=logs

# ===== 安全配置 =====
# 允许的文件扩展名
ALLOWED_IMAGE_EXTENSIONS=png,jpg,jpeg
ALLOWED_VIDEO_EXTENSIONS=mp4,avi,mov,mkv

# ===== CORS配置 =====
# 允许的前端地址（多个地址用逗号分隔）
ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
```

### 8.2 快速配置命令

**复制配置文件**：
```bash
cd backend
cp .env.example .env
```

**编辑配置文件**：
```bash
# Windows
notepad .env

# Linux
nano .env
# 或
vim .env
```

**重启服务**：
```bash
# 先停止旧服务（如果运行中）
# 然后启动新服务
python app.py
```

---

通过本文档的指导，您应该能够轻松应对不同环境下的配置变更，确保绝缘子缺陷检测系统在各种部署环境中都能正常运行。如果遇到配置问题，请参考故障排查部分或联系技术支持。