# 后端启动指导文档

## 1. 项目概述

本项目是一个基于YOLOv11的绝缘子缺陷检测系统，后端使用Flask框架开发，支持图片和视频的缺陷检测，具备实时摄像头检测功能。

## 2. 环境配置

### 2.1 当前环境依赖

系统已生成完整的依赖文件 `backend/requirements.txt`，包含以下核心依赖：

- Flask: Web框架
- ultralytics: YOLOv11模型
- torch: PyTorch深度学习框架
- opencv-python: 图像处理
- pymysql: 数据库连接
- python-dotenv: 环境变量管理
- flask-cors: 跨域支持

### 2.2 环境变量配置

后端使用 `.env` 文件管理配置，主要配置项包括：

```dotenv
# 服务器配置
SERVER_PORT=5000

# 数据库配置
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=123456
DB_NAME=insulator_detection

# 路径配置
UPLOAD_FOLDER=uploads
RESULT_FOLDER=results
VIDEO_FOLDER=videos
MODEL_FOLDER=models
LOG_FOLDER=logs

# 模型配置
DEFAULT_MODEL=best.pt
CONF_THRESHOLD=0.25
IOU_THRESHOLD=0.45

# 设备配置
USE_GPU=auto

# CORS配置
ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
```

## 3. 启动方法

### 3.1 使用当前安装的依赖环境

1. **进入后端目录**：
   ```bash
   cd backend
   ```

2. **直接启动服务**：
   ```bash
   python app.py
   ```

3. **验证启动成功**：
   启动后会看到类似以下输出：
   ```
   INFO:app:[启动] YOLOv11绝缘子缺陷检测系统后端启动
   INFO:app:[主机]主机名: Bins
   INFO:app:[IP]服务器IP: 192.168.244.1:5000
   INFO:app:[工具]PyTorch版本: 2.10.0+cu128
   INFO:app:[设备]GPU 0: NVIDIA GeForce RTX 5060 Ti
   ✅ 数据库表创建/验证成功
   INFO:app:[成功]数据库初始化成功
   INFO:app:模型加载成功: best.pt (设备: cuda:0)
   
   ==================================================
   🚀 YOLOv11绝缘子缺陷检测系统启动
   ==================================================
   📡 本地地址: http://localhost:5000
   🌐 内网地址: http://192.168.244.1:5000
   📁 上传目录: D:\Program\Develop\deeplearning\git_yolo_detect\backend\uploads
   📁 结果目录: D:\Program\Develop\deeplearning\git_yolo_detect\backend\results
   🔧 检测设备: cuda:0
   ==================================================
   
   * Serving Flask app 'app'
   * Debug mode: off
   * Running on all addresses (0.0.0.0)
   * Running on http://127.0.0.1:5000
   ```

### 3.2 使用conda环境

1. **激活yolo环境**：
   ```bash
   conda activate yolo
   ```

2. **进入后端目录**：
   ```bash
   cd backend
   ```

3. **启动服务**：
   ```bash
   python app.py
   ```

4. **如果缺少依赖**，可以安装：
   ```bash
   pip install -r requirements.txt
   ```

## 4. IP地址变更处理

### 4.1 自动IP识别

系统具有自动IP识别功能，会在启动时自动检测并显示所有可用的网络IP地址，包括：

- 本地地址: http://localhost:5000
- 内网地址: 例如 http://192.168.1.11:5000
- 所有网络接口的IP地址

### 4.2 更换服务器时的配置

当更换服务器或IP地址变更时，**无需修改代码**，系统会自动：

1. **检测新服务器的IP地址**：启动时自动扫描所有网络接口
2. **适应新的网络环境**：显示新服务器的所有可用IP
3. **保持服务可用性**：在新IP地址上正常提供服务

### 4.3 前端连接配置

前端需要根据后端的实际IP地址进行配置，主要有两种方式：

1. **开发环境**：前端默认连接 http://localhost:5000
2. **生产环境**：需要在前端配置中修改API基础地址为新服务器的IP

## 5. 目录结构

```
backend/
├── app.py              # 主程序文件
├── .env                # 环境变量配置
├── .env.example        # 环境变量示例
├── requirements.txt    # 依赖文件
├── uploads/            # 上传文件目录
├── results/            # 结果文件目录
├── models/             # 模型文件目录
├── videos/             # 视频文件目录
└── logs/               # 日志文件目录
```

## 6. 核心功能

- **图片检测**：支持上传图片进行绝缘子缺陷检测
- **视频检测**：支持上传视频文件进行缺陷检测
- **摄像头检测**：支持实时摄像头缺陷检测
- **历史记录**：保存检测历史，支持查询和管理
- **模型管理**：支持多模型切换

## 7. 故障排查

### 7.1 常见问题

1. **端口被占用**：系统会自动查找可用端口
2. **GPU不可用**：自动降级到CPU模式
3. **模型加载失败**：检查models目录下是否有模型文件
4. **数据库连接失败**：检查数据库配置和服务状态

### 7.2 日志查看

系统日志保存在 `logs/app.log` 文件中，包含详细的运行信息和错误记录。

## 8. 性能优化

- **设备自动选择**：优先使用GPU，无GPU时自动使用CPU
- **内存监控**：内置内存监控，防止内存溢出
- **端口自动分配**：自动查找可用端口
- **模型缓存**：已加载的模型会被缓存，提高切换速度

## 9. 部署建议

- **开发环境**：直接使用 `python app.py` 启动
- **测试环境**：可使用 Gunicorn 等 WSGI 服务器
- **生产环境**：建议使用 Nginx + Gunicorn 部署

## 10. 技术支持

- **系统版本**：v1.0
- **技术支持**：吴权彬
- **联系方式**：[邮箱：1597338110@qq.com 手机：19303010517]

---

**注**：本系统已完全支持跨环境部署，可在Windows和Linux系统上正常运行。