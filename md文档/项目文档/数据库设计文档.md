# 数据库设计文档

## 1. 数据库概述

本数据库设计文档描述了绝缘子缺陷检测系统的数据库结构，包括表结构、字段定义、索引设计和关系模型。系统使用MySQL数据库存储检测记录和用户信息，支持系统的核心功能。

## 2. 数据库配置

### 2.1 数据库连接配置

| 配置项 | 默认值 | 描述 | 环境变量 |
|--------|--------|------|----------|
| 主机地址 | localhost | 数据库服务器地址 | DB_HOST |
| 用户名 | root | 数据库登录用户名 | DB_USER |
| 密码 | 123456 | 数据库登录密码 | DB_PASSWORD |
| 数据库名 | insulator_detection | 数据库名称 | DB_NAME |
| 字符集 | utf8mb4 | 数据库字符集 | - |
| 排序规则 | utf8mb4_unicode_ci | 数据库排序规则 | - |

### 2.2 数据库初始化SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS insulator_detection 
DEFAULT CHARACTER SET utf8mb4 
DEFAULT COLLATE utf8mb4_unicode_ci;

-- 选择数据库
USE insulator_detection;

-- 创建用户表
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    role ENUM('user', 'admin') DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 创建检测记录表
CREATE TABLE IF NOT EXISTS detection_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    filename VARCHAR(255) NOT NULL,
    result_filename VARCHAR(255),
    video_path VARCHAR(255),
    processed_video_path VARCHAR(255),
    model_used VARCHAR(100) NOT NULL,
    confidence_avg FLOAT,
    total_objects INT,
    confidence_threshold FLOAT DEFAULT 0.5,
    iou_threshold FLOAT DEFAULT 0.45,
    detections JSON,
    detection_type ENUM('image', 'video', 'camera') NOT NULL,
    duration FLOAT,  -- 视频时长（秒）
    frame_count INT,  -- 视频帧数
    fps FLOAT,  -- 视频帧率
    device_used VARCHAR(50),  -- 使用的设备
    detect_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- 创建索引
CREATE INDEX idx_detection_type ON detection_records(detection_type);
CREATE INDEX idx_detect_time ON detection_records(detect_time);
CREATE INDEX idx_user_id ON detection_records(user_id);
```

## 3. 表结构设计

### 3.1 users表

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INT | AUTO_INCREMENT PRIMARY KEY | 用户ID |
| username | VARCHAR(100) | NOT NULL UNIQUE | 用户名 |
| password | VARCHAR(255) | NOT NULL | 密码（加密存储） |
| email | VARCHAR(255) | NOT NULL UNIQUE | 邮箱 |
| role | ENUM('user', 'admin') | DEFAULT 'user' | 用户角色 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

### 3.2 detection_records表

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INT | AUTO_INCREMENT PRIMARY KEY | 记录ID |
| user_id | INT | FOREIGN KEY | 用户ID |
| filename | VARCHAR(255) | NOT NULL | 原始文件名 |
| result_filename | VARCHAR(255) | - | 结果文件名 |
| video_path | VARCHAR(255) | - | 视频路径 |
| processed_video_path | VARCHAR(255) | - | 处理后的视频路径 |
| model_used | VARCHAR(100) | NOT NULL | 使用的模型名称 |
| confidence_avg | FLOAT | - | 平均置信度 |
| total_objects | INT | - | 检测到的物体总数 |
| confidence_threshold | FLOAT | DEFAULT 0.5 | 置信度阈值 |
| iou_threshold | FLOAT | DEFAULT 0.45 | IoU阈值 |
| detections | JSON | - | 检测结果详情 |
| detection_type | ENUM('image', 'video', 'camera') | NOT NULL | 检测类型 |
| duration | FLOAT | - | 视频时长（秒） |
| frame_count | INT | - | 视频帧数 |
| fps | FLOAT | - | 视频帧率 |
| device_used | VARCHAR(50) | - | 使用的设备 |
| detect_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 检测时间 |

## 4. 数据模型关系

### 4.1 实体关系图

```
┌─────────────┐       ┌─────────────────────┐
│    users    │       │ detection_records  │
├─────────────┤       ├─────────────────────┤
│ id (PK)     │───────│ user_id (FK)        │
│ username    │       │ id (PK)             │
│ password    │       │ filename            │
│ email       │       │ result_filename     │
│ role        │       │ video_path          │
│ created_at  │       │ processed_video_path│
│ updated_at  │       │ model_used          │
└─────────────┘       │ confidence_avg      │
                      │ total_objects       │
                      │ detections          │
                      │ detection_type      │
                      │ detect_time         │
                      └─────────────────────┘
```

### 4.2 关系说明

1. **用户与检测记录**：一对多关系
   - 一个用户可以创建多条检测记录
   - 每条检测记录属于一个用户
   - 外键：`detection_records.user_id` 引用 `users.id`

2. **检测记录与文件**：一对一关系
   - 每条检测记录关联一个原始文件和一个结果文件
   - 视频检测还关联视频文件和处理后的视频文件

3. **检测记录与模型**：多对一关系
   - 多条检测记录可以使用同一个模型
   - 每个模型可以被多条检测记录使用

## 5. 数据字典

### 5.1 核心字段说明

| 字段名 | 表名 | 数据类型 | 描述 | 示例值 |
|--------|------|----------|------|--------|
| id | users | INT | 用户ID | 1 |
| username | users | VARCHAR(100) | 用户名 | admin |
| password | users | VARCHAR(255) | 加密后的密码 | $2b$12$... |
| role | users | ENUM | 用户角色 | admin |
| id | detection_records | INT | 记录ID | 1001 |
| user_id | detection_records | INT | 用户ID | 1 |
| filename | detection_records | VARCHAR(255) | 原始文件名 | insulator_001.jpg |
| result_filename | detection_records | VARCHAR(255) | 结果文件名 | result_insulator_001.jpg |
| model_used | detection_records | VARCHAR(100) | 使用的模型 | best.pt |
| confidence_avg | detection_records | FLOAT | 平均置信度 | 0.85 |
| total_objects | detection_records | INT | 检测到的物体总数 | 5 |
| detections | detection_records | JSON | 检测结果详情 | [{"class": "破损", "confidence": 0.95, "box": [100, 200, 300, 400]}] |
| detection_type | detection_records | ENUM | 检测类型 | image |
| detect_time | detection_records | TIMESTAMP | 检测时间 | 2024-01-01 12:00:00 |

### 5.2 检测结果JSON格式

```json
[
  {
    "class": "缺陷类型",  // 如"破损", "污秽", "锈蚀"
    "confidence": 0.95,  // 置信度，0-1之间
    "box": [100, 200, 300, 400]  // 边界框坐标
  }
]
```

## 6. 索引设计

### 6.1 索引列表

| 表名 | 索引名 | 索引类型 | 索引字段 | 描述 |
|------|--------|----------|----------|------|
| users | PRIMARY | PRIMARY | id | 主键索引 |
| users | username | UNIQUE | username | 用户名唯一索引 |
| users | email | UNIQUE | email | 邮箱唯一索引 |
| detection_records | PRIMARY | PRIMARY | id | 主键索引 |
| detection_records | idx_user_id | INDEX | user_id | 用户ID索引 |
| detection_records | idx_detection_type | INDEX | detection_type | 检测类型索引 |
| detection_records | idx_detect_time | INDEX | detect_time | 检测时间索引 |

### 6.2 索引优化建议

1. **复合索引**：对于频繁的查询条件组合，可以考虑创建复合索引
   - 例如：`(user_id, detect_time)` 用于按用户和时间范围查询
   - 例如：`(detection_type, detect_time)` 用于按类型和时间范围查询

2. **全文索引**：对于文件名的模糊搜索，可以考虑创建全文索引
   - 例如：`FULLTEXT(filename)` 用于文件名的全文搜索

3. **前缀索引**：对于长字符串字段，可以考虑使用前缀索引
   - 例如：`filename(100)` 可以减少索引大小

## 7. 数据操作示例

### 7.1 插入用户数据

```sql
-- 插入管理员用户
INSERT INTO users (username, password, email, role) 
VALUES ('admin', '$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW', 'admin@example.com', 'admin');

-- 插入普通用户
INSERT INTO users (username, password, email) 
VALUES ('user1', '$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW', 'user1@example.com');
```

### 7.2 插入检测记录

```sql
-- 插入图片检测记录
INSERT INTO detection_records (user_id, filename, result_filename, model_used, confidence_avg, total_objects, detections, detection_type)
VALUES (
    1,
    'insulator_001.jpg',
    'result_insulator_001.jpg',
    'best.pt',
    0.85,
    5,
    '[{"class": "破损", "confidence": 0.95, "box": [100, 200, 300, 400]}, {"class": "污秽", "confidence": 0.75, "box": [400, 500, 600, 700]}]',
    'image'
);

-- 插入视频检测记录
INSERT INTO detection_records (user_id, filename, result_filename, video_path, processed_video_path, model_used, confidence_avg, total_objects, detections, detection_type, duration, frame_count, fps)
VALUES (
    1,
    'insulator_video.mp4',
    'result_insulator_video.mp4',
    'videos/insulator_video.mp4',
    'videos/processed_insulator_video.mp4',
    'best.pt',
    0.82,
    25,
    '[{"frame": 10, "objects": [{"class": "破损", "confidence": 0.95, "box": [100, 200, 300, 400]}]}]',
    'video',
    10.5,
    315,
    30.0
);
```

### 7.3 查询示例

```sql
-- 查询用户的所有检测记录
SELECT * FROM detection_records WHERE user_id = 1 ORDER BY detect_time DESC;

-- 按检测类型查询
SELECT * FROM detection_records WHERE detection_type = 'image' ORDER BY detect_time DESC;

-- 按时间范围查询
SELECT * FROM detection_records WHERE detect_time BETWEEN '2024-01-01' AND '2024-01-31' ORDER BY detect_time DESC;

-- 统计用户的检测记录数量
SELECT COUNT(*) FROM detection_records WHERE user_id = 1;

-- 统计每种检测类型的数量
SELECT detection_type, COUNT(*) AS count FROM detection_records GROUP BY detection_type;

-- 查询检测到物体最多的记录
SELECT * FROM detection_records ORDER BY total_objects DESC LIMIT 10;

-- 关联查询用户和检测记录
SELECT u.username, d.* FROM detection_records d
JOIN users u ON d.user_id = u.id
ORDER BY d.detect_time DESC;
```

### 7.4 更新示例

```sql
-- 更新用户密码
UPDATE users SET password = '$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW' WHERE id = 1;

-- 更新检测记录
UPDATE detection_records SET confidence_avg = 0.90 WHERE id = 1001;
```

### 7.5 删除示例

```sql
-- 删除检测记录
DELETE FROM detection_records WHERE id = 1001;

-- 批量删除检测记录
DELETE FROM detection_records WHERE id IN (1001, 1002, 1003);

-- 删除用户的所有检测记录
DELETE FROM detection_records WHERE user_id = 2;

-- 删除用户
DELETE FROM users WHERE id = 2;
```

## 8. 性能优化

### 8.1 查询优化

1. **使用索引**：确保查询条件使用了适当的索引
2. **避免全表扫描**：对于大表，避免使用 `SELECT *` 和无索引的条件查询
3. **分页查询**：使用 `LIMIT` 子句进行分页，避免一次性查询所有数据
4. **使用连接**：合理使用 `JOIN` 代替子查询
5. **缓存结果**：对于频繁查询的数据，考虑使用缓存

### 8.2 存储优化

1. **分区表**：对于 `detection_records` 表，可以考虑按时间范围分区
   ```sql
   -- 按年份分区
   ALTER TABLE detection_records PARTITION BY RANGE (YEAR(detect_time)) (
       PARTITION p2024 VALUES LESS THAN (2025),
       PARTITION p2025 VALUES LESS THAN (2026),
       PARTITION pfuture VALUES LESS THAN MAXVALUE
   );
   ```

2. **压缩表**：对于历史数据，可以考虑使用表压缩
   ```sql
   ALTER TABLE detection_records ROW_FORMAT=COMPRESSED;
   ```

3. **定期清理**：定期清理过期或不再需要的数据
   ```sql
   -- 删除一年前的检测记录
   DELETE FROM detection_records WHERE detect_time < DATE_SUB(NOW(), INTERVAL 1 YEAR);
   ```

### 8.3 配置优化

1. **调整MySQL配置**：根据服务器硬件配置调整MySQL参数
   - `innodb_buffer_pool_size`：建议设置为服务器内存的70-80%
   - `max_connections`：根据并发需求调整
   - `query_cache_size`：对于只读查询较多的场景，可以适当调整

2. **使用连接池**：应用程序使用数据库连接池，减少连接建立的开销

3. **读写分离**：对于高并发场景，考虑使用读写分离架构

## 9. 安全性考虑

### 9.1 数据安全

1. **密码加密**：用户密码使用bcrypt等安全算法加密存储
2. **数据脱敏**：对于敏感信息，如邮箱，在查询结果中进行脱敏处理
3. **备份策略**：定期备份数据库，确保数据安全

### 9.2 访问控制

1. **最小权限原则**：数据库用户只授予必要的权限
   ```sql
   -- 创建只读用户
   CREATE USER 'readonly'@'localhost' IDENTIFIED BY 'password';
   GRANT SELECT ON insulator_detection.* TO 'readonly'@'localhost';
   
   -- 创建读写用户
   CREATE USER 'readwrite'@'localhost' IDENTIFIED BY 'password';
   GRANT SELECT, INSERT, UPDATE, DELETE ON insulator_detection.* TO 'readwrite'@'localhost';
   ```

2. **防止SQL注入**：使用参数化查询，避免直接拼接SQL语句

3. **限制连接来源**：限制数据库用户的连接来源
   ```sql
   CREATE USER 'app'@'192.168.1.%' IDENTIFIED BY 'password';
   ```

## 10. 数据库迁移

### 10.1 版本控制

建议使用数据库迁移工具，如Flyway或Liquibase，对数据库结构变更进行版本控制。

### 10.2 迁移示例

```sql
-- 新增字段示例
ALTER TABLE detection_records ADD COLUMN device_used VARCHAR(50) AFTER fps;

-- 修改字段示例
ALTER TABLE detection_records MODIFY COLUMN confidence_threshold FLOAT DEFAULT 0.6;

-- 新增索引示例
CREATE INDEX idx_model_used ON detection_records(model_used);
```

## 11. 监控与维护

### 11.1 监控指标

1. **查询性能**：监控慢查询日志，优化性能瓶颈
2. **连接数**：监控数据库连接数，避免连接池耗尽
3. **存储空间**：监控数据库存储空间使用情况
4. **索引使用**：监控索引使用情况，优化索引设计

### 11.2 维护任务

1. **定期优化表**：使用 `OPTIMIZE TABLE` 命令优化表结构
   ```sql
   OPTIMIZE TABLE detection_records;
   ```

2. **更新统计信息**：定期更新表的统计信息，确保查询优化器做出正确的决策
   ```sql
   ANALYZE TABLE detection_records;
   ```

3. **检查表结构**：定期检查表结构的完整性
   ```sql
   CHECK TABLE detection_records;
   ```

## 12. 结论

本数据库设计文档提供了绝缘子缺陷检测系统的完整数据库结构设计，包括表结构、字段定义、索引设计和关系模型。数据库设计考虑了系统的核心功能需求，支持图片、视频和摄像头检测的记录存储，同时兼顾了性能优化和安全性。

通过合理的表结构设计和索引优化，数据库能够高效地存储和查询检测记录，支持系统的各种功能需求。同时，通过定期的维护和监控，可以确保数据库的稳定运行和性能优化。