# 核心功能模块分析

## 1. 主要API端点分析

从后端`app.py`文件中，我们可以推断出以下主要API端点：

### 1.1 核心检测API
- **POST /api/detect** - 图片检测端点，处理图片上传和缺陷检测
- **POST /api/video/detect** - 视频检测端点，处理视频上传和缺陷检测
- **POST /api/camera/start** - 启动服务器摄像头检测
- **POST /api/camera/stop** - 停止服务器摄像头检测
- **GET /api/camera/stream** - 获取服务器摄像头视频流
- **POST /api/camera/detect_frame** - 处理本地摄像头帧（新功能）

### 1.2 设备管理API
- **GET /api/device_info** - 获取当前设备信息（CPU/GPU）
- **POST /api/switch_device** - 切换检测设备（CPU/GPU）

### 1.3 历史记录API
- **GET /api/history** - 获取所有历史检测记录
- **GET /api/records/<int:record_id>** - 获取单条记录详细信息
- **DELETE /api/records/<int:record_id>** - 删除单条记录
- **POST /api/records/batch_delete** - 批量删除记录

### 1.4 系统API
- **GET /api/health** - 健康检查端点，检查系统状态

## 2. 页面功能分析

从前端路由配置和组件结构，我们可以推断出以下页面功能：

### 2.1 认证页面
- **/login** - 登录页面，用户认证入口
- **/register** - 注册页面，新用户注册

### 2.2 检测功能页面
- **/upload** - 图片上传检测页面，支持单张/批量图片上传和实时检测
- **/video** - 视频检测页面，支持视频上传和摄像头实时检测（包括本地和服务器摄像头）

### 2.3 记录管理页面
- **/history** - 历史记录页面，查看和管理所有检测记录，支持筛选、搜索和批量操作
- **/record/:id** - 记录详情页面，查看单条检测记录的详细信息

### 2.4 系统页面
- **/about** - 关于页面，显示系统信息和使用说明

## 3. 数据模型和业务实体关系

### 3.1 主要数据模型
从后端代码中，我们可以看到主要的数据模型是`detection_records`表，包含以下关键字段：

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | 整数 | 记录ID（主键） |
| filename | 字符串 | 原始文件名 |
| result_filename | 字符串 | 结果文件名 |
| video_path | 字符串 | 视频路径 |
| processed_video_path | 字符串 | 处理后的视频路径 |
| model_used | 字符串 | 使用的模型名称 |
| confidence_avg | 浮点数 | 平均置信度 |
| total_objects | 整数 | 检测到的物体总数 |
| confidence_threshold | 浮点数 | 置信度阈值 |
| iou_threshold | 浮点数 | IoU阈值 |
| detections | JSON | 检测结果详情 |
| detection_type | 字符串 | 检测类型（image/video/camera） |
| duration | 浮点数 | 视频时长（秒） |
| frame_count | 整数 | 视频帧数 |
| fps | 浮点数 | 视频帧率 |
| detect_time | 时间戳 | 检测时间 |

### 3.2 业务实体关系
- **用户与检测记录**：一对多关系，一个用户可以创建多条检测记录
- **检测记录与模型**：多对一关系，多条检测记录可以使用同一个模型
- **检测记录与文件**：一对一关系，每条检测记录关联一个原始文件和一个结果文件

## 4. 权限控制和用户角色设计

### 4.1 权限控制机制
从前端路由和后端代码分析，系统实现了基本的用户认证机制：
- 前端有登录和注册页面
- 后端应该有对应的用户认证API

### 4.2 用户角色设计
根据系统功能，推测用户角色可能包括：

| 角色 | 权限 | 功能 |
|------|------|------|
| 普通用户 | 基础权限 | 上传图片/视频进行检测，查看自己的检测记录，使用摄像头进行实时检测 |
| 管理员 | 全部权限 | 除普通用户权限外，还可以查看所有用户的检测记录，管理用户账号，管理检测模型，系统配置等 |

### 4.3 权限控制实现
- **前端**：通过路由守卫和状态管理实现权限控制，未登录用户只能访问登录/注册页面
- **后端**：通过API中间件实现权限控制，验证用户身份和权限

## 5. 技术架构总结

### 5.1 前端技术栈
- Vue 3.5.26
- TypeScript 5.9.3
- Element Plus 2.13.0
- Vite 7.3.0
- Pinia 3.0.4
- Vue Router 4.6.4
- Axios 1.13.2

### 5.2 后端技术栈
- Python 3.x
- Flask
- YOLOv11 (ultralytics)
- PyTorch 2.10.0+cu128
- OpenCV
- MySQL (pymysql)
- python-dotenv

### 5.3 系统架构
- **前端**：单页应用，使用Vue 3 + TypeScript构建，通过Axios与后端API通信
- **后端**：Flask RESTful API，处理文件上传、模型推理和数据存储
- **数据库**：MySQL存储检测记录和用户信息
- **模型**：YOLOv11模型用于缺陷检测
- **存储**：本地文件系统存储上传文件和检测结果

## 6. 核心功能模块流程图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户认证   │     │  检测功能   │     │  记录管理   │
├─────────────┤     ├─────────────┤     ├─────────────┤
│  登录/注册  │────>│  图片检测   │────>│  历史记录   │
│             │     │  视频检测   │     │  记录详情   │
│             │     │  摄像头检测 │     │  批量操作   │
└─────────────┘     └─────────────┘     └─────────────┘
```

## 7. 技术亮点

1. **多模态检测**：支持图片、视频和摄像头实时检测
2. **设备自适应**：自动检测和切换CPU/GPU设备
3. **实时摄像头检测**：支持本地和服务器摄像头
4. **丰富的前端交互**：筛选、搜索、批量操作等功能
5. **完整的历史记录管理**：支持查看、删除、导出检测记录
6. **详细的检测结果**：包括置信度、位置、类别等信息
7. **美观的UI设计**：现代化的响应式界面

## 8. 改进建议

1. **权限控制增强**：实现更细粒度的权限控制，区分普通用户和管理员
2. **模型管理**：添加模型上传、管理和切换功能
3. **数据可视化**：添加检测结果的统计和可视化功能
4. **API文档**：添加API文档，方便前端开发和集成
5. **错误处理**：增强错误处理和用户提示
6. **性能优化**：优化大文件上传和处理速度
7. **安全性**：增强文件上传验证和API访问控制
8. **部署方案**：提供容器化部署方案，方便在不同环境中部署
